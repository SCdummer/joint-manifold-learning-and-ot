import os
import numpy as np
from PIL import Image
import matplotlib.pyplot as plt

# Define the main directory of the repository
main_dir = os.path.join(os.path.basename(__file__), "..", "..")

# The function that transforms images to pngs generated by Matplotlib
def save_individual_images(file_list, save_dir, max_val):  
    
    img_array_list = [np.array(Image.open(file)) for file in file_list]
    
    for i in range(len(file_list)):
        arr = np.array(Image.open(file_list[i]))
        print(file_list[i], arr.max())
    
    for img_arr, file in zip(img_array_list, file_list):
        if not os.path.isdir(save_dir):
            os.makedirs(save_dir)
        fig, ax = plt.subplots()
        plt.imshow(img_arr.squeeze().astype(np.float32) / max_val, vmin=0, vmax=1.0)
        plt.gca().set_axis_off()
        plt.subplots_adjust(top=1, bottom=0, right=1, left=0,
                            hspace=0, wspace=0)
        plt.margins(0, 0)
        plt.gca().xaxis.set_major_locator(plt.NullLocator())
        plt.gca().yaxis.set_major_locator(plt.NullLocator())
        file_name = 'track' + os.path.basename(file).split('_')[0][5:] + '_' + str(int(os.path.basename(file).split('_')[1][1:4]))
        plt.savefig(os.path.join(save_dir, file_name + '.png'), bbox_inches='tight',
                    pad_inches=0)
        plt.close('all')
    
if __name__ == "__main__":
    
    # Define the parameters
    max_val = 0.7
    save_dir = os.path.join(main_dir, "data/Fluo-N2DL-HeLa/")
    track_ids = ['288', '50', '284', '76', '257', '372', '177', '200', '125', '270']
    main_main_dir = "data/Fluo-N2DL-HeLa/01_processed/01_processed/"
    
    # Processing everything
    for track_id in track_ids:
        main_dir = os.path.join(main_main_dir, "Track" + track_id)
        files = os.listdir(main_dir)
        files.sort()
        file_list = [os.path.join(main_dir, file) for file in files]
        save_individual_images(file_list, os.path.join(save_dir, "Track" + track_id), max_val=max_val)
